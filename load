function replaceCustomToBlobInAssets(project, customToBlobMap) {
  if (!project.assets || !Array.isArray(project.assets)) {
    console.warn("[RESTORE] âš ï¸ No assets found in project");
    return;
  }

  for (const asset of project.assets) {
    const src = asset.src;
    const blobUrl = customToBlobMap[src];

    if (src?.startsWith('custom:') && blobUrl) {
      console.log(`[RESTORE] ğŸ” asset.src: ${src} â†’ ${blobUrl}`);
      asset.src = blobUrl;
    } else {
      console.warn(`[RESTORE] âš ï¸ Skipping asset â€“ no match for custom: ${src}`);
    }
  }
}


function replaceCustomToBlobInPages(project, customToBlobMap) {
  if (!project?.pages) return;

  console.log("[RESTORE] â–¶ï¸ Start customâ†’blob replacement in pages");

  for (const page of project.pages) {
    for (const frame of page.frames || []) {
      recurseComponents(frame.component);
    }
  }

  function recurseComponents(component) {
    if (!component || typeof component !== 'object') return;

    // BezpoÅ›redni src
    if (component.src && customToBlobMap[component.src]) {
      console.log("[RESTORE] ğŸ” component.src:", component.src, "â†’", customToBlobMap[component.src]);
      component.src = customToBlobMap[component.src];
    }

    // WewnÄ…trz attributes
    if (component.attributes?.src && customToBlobMap[component.attributes.src]) {
      console.log("[RESTORE] ğŸ” component.attributes.src:", component.attributes.src, "â†’", customToBlobMap[component.attributes.src]);
      component.attributes.src = customToBlobMap[component.attributes.src];
    }

    // Rekurencja â€“ przetwarzamy dzieci
    if (Array.isArray(component.components)) {
      for (const child of component.components) {
        recurseComponents(child);
      }
    }
  }

  console.log("[RESTORE] âœ… Finished customâ†’blob replacement");
}

function restoreBlobURLs(project, assets) {
  const customToBlobMap = {};

  // ğŸ” Tworzymy mapÄ™ custom: â†’ blob:
  for (const a of assets) {
    const src = a.get('src');
    const name = a.get('name');

    if (src && name && src.startsWith('blob:')) {
      const custom = `custom:anvil-assets/${name}`;
      customToBlobMap[custom] = src;
    }
  }

  // ğŸ” Zamiana w `assets`
  replaceCustomToBlobInAssets(project, customToBlobMap);

  // ğŸ” Zamiana w `pages`
  replaceCustomToBlobInPages(project, customToBlobMap);
}
