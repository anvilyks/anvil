const waitForAssets = (min = 1) =>
    new Promise((resolve) => {
      const check = () => {
        const assets = editor.AssetManager.getAll().models;
        if (assets.length >= min) {
          resolve(assets);
        } else {
          setTimeout(check, 100); // Sprawdza co 100ms
        }
      };
      check();
    });

  const assets = await waitForAssets(1); // lub np. 10

  console.log("âœ… AssetManager gotowy:", assets.length, "assetÃ³w");

  // ðŸ“¦ ZaÅ‚aduj projekt z backendu
  const project = await window.load_files_callback();
  console.log("ðŸ“¥ Projekt pobrany");

  // ðŸ”„ PrzywrÃ³Ä‡ blob: z custom:
  restoreBlobURLs(project, assets);

  // ðŸ” ZamieÅ„ blob: â†’ custom: przed zapisem
  const customToBlobMap = {};
  for (const a of assets) {
    const src = a.get("src");
    const name = a.get("name");
    if (src?.startsWith("blob:") && name) {
      customToBlobMap[`custom:anvil-assets/${name}`] = src;
    }
  }

  replaceBlobToCustomInPages(project, customToBlobMap);

  // ðŸ”§ Debug: pokaÅ¼ strukturÄ™
  console.dir(project, { depth: null });

  // â³ Åadowanie projektu (setTimeout = opÃ³Åºnienie na Canvas/pages)
  setTimeout(async () => {
    await editor.loadProjectData(project);
    console.log("âœ… Projekt zaÅ‚adowany");
  }, 0);
