<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- ... -->
    <script src="https://unpkg.com/@grapesjs/studio-sdk/dist/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@grapesjs/studio-sdk-plugins@latest/dist/rteTinyMce/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@grapesjs/studio-sdk-plugins@latest/dist/layoutSidebarButtons/index.umd.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@grapesjs/studio-sdk/dist/style.css"/>
  </head>
  <body>
    <div id="studio-editor" style="height: 100dvh"></div>
    <script>
     
        let editor; // globalna zmienna

      const onReady = (studioEditor) => {
        editor = studioEditor;
        window.editorInstance = editor;
        window.studioEditor = studioEditor;
        const previewButton = document.querySelector('button .gs-cmp-icon path[d*="M2 12H4V18Qv12H22V17C22"]')?.closest('button');
        if (previewButton) {
          previewButton.remove();
          console.log('Usunięto przycisk Preview');
        };

        // ⬇️ TU WKLEJ TO:
        const idsToRemove = [
          'mj-hero',
          'mj-navbar',
          'mj-social',
          'mj-social-element',
          'mj-raw'
        ];

        if (editor.BlockManager && typeof editor.BlockManager.remove === 'function') {
          idsToRemove.forEach(id => {
            if (editor.BlockManager.get(id)) {
              editor.BlockManager.remove(id);
            }
          });
        };
        editor.AssetManager.add({
          src: "https://wilted-tremendous-east.anvil.app/_/theme/baner.png",
          name: "Baner z Anvil",
          category: "Anvil",
        });
        

      };
  
        const toggleAddPage = () => {
          if (!editor) return console.warn("Editor not ready");
          const config = editor.runCommand(GrapesJsStudioSDK.StudioCommands.getPagesConfig) || {};
          editor.runCommand(GrapesJsStudioSDK.StudioCommands.setPagesConfig, {
            config: { add: !config.add }
          });
        };
  
        const togglePageSettings = () => {
          if (!editor) return console.warn("Editor not ready");
          const state = editor.runCommand(GrapesJsStudioSDK.StudioCommands.getPageSettings) || {};
          editor.runCommand(GrapesJsStudioSDK.StudioCommands.setPageSettings, {
            isOpen: !state.isOpen
          });
        };
        const ed = GrapesJsStudioSDK.createStudioEditor({
        root: '#studio-editor',
        licenseKey: '2212ca00d8524845ab8b2e7285c750714884c9f3d17642509f3830631f057be9',
        theme: 'dark',
        
        project: {
          type:'email',
          id: 'UNIQUE_PROJECT_ID'
        },
          identity: {
            // TODO: replace with a unique id for your end users. e.g. an uuid
            id: 'UNIQUE_END_USER_ID'
          },
          onReady,
          assets: {
            storageType: 'cloud'
          },
        storage: {
          type: 'self',
          // Provide a custom handler for saving the project data.
          onSave: async ({ project }) => {
            
            // const selectedPage = editor.Pages.getSelected();
            // if (!selectedPage) throw new Error("Brak wybranej strony");

            // const component = selectedPage.getMainComponent();
            //const html = editor.getHtml({ component });
            // const css = editor.getCss({ component });
            
            // console.log(html, css)
        
            window.save_template_callback('html', project).then(result => {
              console.log("✅ async result:", result);
            });

           
           
            // await fetch("https://wilted-tremendous-east.anvil.app/_/api/save-template", {
            //   method: "POST",
            //   headers: {
            //     "Content-Type": "application/json"
            //   },
            //   body: JSON.stringify({
            //     template_id: "template-0013",
            //     content: 1
            //   })
            // })
            //   .then(async res => {
            //     const contentType = res.headers.get("content-type");
            //     const isJson = contentType && contentType.includes("application/json");

            //     if (!res.ok) {
            //       const text = await res.text();
            //       throw new Error("Server error: " + text);
            //     }

            //     return isJson ? res.json() : res.text();
            //   })
            //   .then(data => {
            //     console.log("Zapis zakończony:", data);
            //   })
            //   .catch(err => {
            //     console.error("Błąd zapisu:", err.message);
            //   });

          },
          // Provide a custom handler for loading project data.
          onLoad: async () => {
            
            const valueFromAnvil = window.form_test_value;  // ⬅️ dostęp do wartości z Anvil
            

            const response = await fetch('https://wilted-tremendous-east.anvil.app/_/api/get-template');
            const project = await response.json();
            // The project JSON is expected to be returned inside an object.
            return { project };
          },
          autosaveChanges: 100,
          autosaveIntervalMs: 10000
        },
        plugins: [
          StudioSdkPlugins_rteTinyMce.init({ /* Plugin options: https://app.grapesjs.com/docs-sdk/plugins/rte/tinymce */ }),
          StudioSdkPlugins_layoutSidebarButtons.init({ /* Plugin options: https://app.grapesjs.com/docs-sdk/plugins/layout/sidebar-buttons */ })
        ]
      });
      

    </script>
  </body>
  <html>
